<!DOCTYPE html>
<html>
  <head>
    <title>お絵かきツール</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

     <style>
        body {
           background: #eee;
        }

        #canvas {
           margin: 10px;
           background: #;
           border: 1px solid #aaaaaa;
        }

         #canvas1 {
           margin: 10px;
           background: #ffffff;
           border: 1px solid #aaaaaa;
        }

        input[type="image"]{
        	padding: 2px;
        	outline: none;
        }

        input[type="image"].active{
        	background-color: #fff;
        }



     </style>


  </head>

<body>
	<canvas id="canvas1" width="700" height="500" style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas>
	<canvas id="canvas" width="700" height="500" style="position: absolute; left: 0; top: 0; z-index: 2;"></canvas>

<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
	<label>色<input id="color" type="color"></label>
	<label>太さ<input id="width" type="number" min="1" max="30" value="1"></label>
	<input type="button" id="delete_canvas" value="クリア" onClick="delete_canvas()">
  	<input type="image" id="pencil" src="1.png" width="35px" class="active" onClick="tool(1)">
  	<input type="image" id="eraser" src="2.png" width="35px" onClick="tool(2)">

<script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="reconnecting-websocket.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>

<script type="text/javascript">
var socket = io.connect("http://192.168.11.10:8081");

socket.on("connected", function(name){});
socket.on("publish", function(data){ addMessage(data);});
socket.on("disconnect", function(){});


datahairetu = [];
i = 0;
btn = 1;

function start(name){
	socket.emit("connected", name);
}

function addMessage(data){

	switch(data.act) {

	case "down":
		ctx.strokeStyle = data.rgb;
        ctx.beginPath();
        ctx.moveTo(data.x, data.y);

	case "move":

		ctx.lineCap = 'round';
		if(data.btn == 2) {
			ctx.globalCompositeOperation = 'destination-out';
		}
		ctx.strokeStyle = data.rgb;
		ctx.lineWidth = data.w;
		ctx.lineTo(data.x, data.y);
        ctx.stroke();
        ctx.globalCompositeOperation = 'source-over';
        break;

	case "dele":
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		socket.emit("publish",1);
		break;

	}

};





	var drawing = false;
	// 前回の座標を記録する（初期値：０）
	var before_x = 0;
	var before_y = 0;

	var canvas = document.getElementById('canvas');
	var ctx = canvas.getContext('2d');

	var canvas1 = document.getElementById('canvas1');
	var ctx1 = canvas1.getContext('2d');
	ctx.fillText("Hello World!!", 15, 65);
	var background = new Image();
	background.src = "u.png";

	//画像をCanvasのサイズに合わせて等倍して画像をcanvasに貼り付ける.
	var canvas_width = 300;
	var canvas_hegiht = 400;
	background.onload = function(){
	    //canvas_widthを height / width倍する.
	    ctx1.drawImage(background,0,0,canvas_width, background.height * canvas_width / background.width);
	}

	canvas.addEventListener('mousemove', draw_canvas);
	// マウスをクリックしてる時
	canvas.addEventListener('mousedown', function(e) {
		drawing = true;
		var rect = e.target.getBoundingClientRect();
		before_x = e.clientX - rect.left;
		before_y = e.clientY - rect.top;

		datahairetu.push({
			act: "down",
			x: before_x,
			y: before_y,
		});

		/*socket.emit("publish",{
			act: "down",
			x: before_x,
			y: before_y,
		});*/

	});
	// マウスをクリックしてない時
	canvas.addEventListener('mouseup', function() {
		drawing = false;
		var length = datahairetu.length;
		for (var i = 0; i < length; ++i) {
			socket.emit("publish",datahairetu[0]);
			datahairetu.shift();
		}



	});

// 描画の処理
function draw_canvas(e) {
	// drawingがtrueじゃなかったら返す
	if (!drawing){
		return
	};
	var rect = e.target.getBoundingClientRect();
	var x = e.clientX - rect.left;
	var y = e.clientY - rect.top;
	var w = document.getElementById('width').value;
	var color = document.getElementById('color').value;
	var r   = parseInt(color.substring(1,3), 16);
	var g = parseInt(color.substring(3,5), 16);
	var b  = parseInt(color.substring(5,7), 16);




	datahairetu.push({
		act: "move",
		x: x,
		y: y,
		w: w,
		btn: btn,
		rgb: 'rgb('+ r + ',' + g + ',' + b + ')',
	});
	/*socket.emit("publish",{
		act: "move",
		x: x,
		y: y,
		w: w,
		rgb: 'rgb('+ r + ',' + g + ',' + b + ')',
	});*/




	// 描画
	ctx.lineCap = 'round';
	ctx.strokeStyle = 'rgb('+ r + ',' + g + ',' + b + ')';
	ctx.lineWidth = w;
	ctx.beginPath();
	ctx.moveTo(before_x, before_y);
	ctx.lineTo(x, y);
	ctx.stroke();
	ctx.closePath();
	// 描画最後の座標を前回の座標に代入する
	before_x = x;
	before_y = y;

}

// クリアボタンクリック時
// クリアボタンクリックした時にアラートを表示
function delete_canvas(){
  ret = confirm('canvasの内容を削除します。');
  // アラートで「OK」を選んだ時
  if (ret == true){

  	ctx.clearRect(0, 0, canvas.width, canvas.height);
  	socket.emit("publish",{
		act: "dele",
	});
  }
}

var pen = document.getElementById('pencil');
var era = document.getElementById('eraser');
// 鉛筆と消しゴムの切り替え

function tool(btnNum){
// クリックされボタンが鉛筆だったら
  if (btnNum == 1){
    ctx.globalCompositeOperation = 'source-over';
    pen.className = 'active';
    era.className = '';
    pen = 'active';
    btn = 1;
  }
// クリックされボタンが消しゴムだったら
  else if (btnNum == 2){
    ctx.globalCompositeOperation = 'destination-out';
    pen.className = '';
    era.className = 'active';
    btn = 2;
  }
}

var createImage= function(context){
	  var image= new Image
	  image.src= context.canvas.toDataURL()
	  return image
	}

	var context1= document.createElement('canvas').getContext('2d')
	context1.fillText('foo',0,10)

	var context2= document.createElement('canvas').getContext('2d')
	context2.fillText('bar',0,20)

	var context3= document.createElement('canvas').getContext('2d')
	context3.fillText('baz',0,30)

	var context4= document.createElement('canvas').getContext('2d')
	context4.drawImage(createImage(context1),0,0)
	context4.drawImage(createImage(context2),0,0)
	context4.drawImage(createImage(context3),0,0)

	document.body.appendChild(createImage(context4))

</script>
<form action="javascript:void(0);">
<input type="text" id="msg" size="20">
<input type="button" id="connect" value="Connect" onclick="WebSocketDemo.connect();">
<input type="button" id="send" value="Send" onclick="WebSocketDemo.send();" disabled>
</form>

</body>
</html>
